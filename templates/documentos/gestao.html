{% extends "base.html" %}

{% block title %}Gestão de Documentos{% endblock %}

{% block content %}
<h1 class="h2 mb-4">Gestão de Documentos</h1>

<ul class="nav nav-tabs" id="gestaoTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="revisao-tab" data-bs-toggle="tab" data-bs-target="#revisao" type="button" role="tab" aria-controls="revisao" aria-selected="true">
            Revisão de Documentos
            {% if documentos_para_revisar %}
                <span class="badge rounded-pill bg-danger">{{ documentos_para_revisar|length }}</span>
            {% endif %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="solicitar-tab" data-bs-toggle="tab" data-bs-target="#solicitar" type="button" role="tab" aria-controls="solicitar" aria-selected="false">
            Solicitar Documento
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="enviar-tab" data-bs-toggle="tab" data-bs-target="#enviar" type="button" role="tab" aria-controls="enviar" aria-selected="false">
            Enviar Manualmente
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="consulta-tab" data-bs-toggle="tab" data-bs-target="#consulta" type="button" role="tab" aria-controls="consulta" aria-selected="false">
            Consultar Documentos
        </button>
    </li>
</ul>

<div class="tab-content" id="gestaoTabContent">
    
    <div class="tab-pane fade show active" id="revisao" role="tabpanel" aria-labelledby="revisao-tab">
        <div class="card shadow-sm card-tab">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-check"></i> Documentos Pendentes de Revisão</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Funcionário</th>
                                <th>Tipo do Documento</th>
                                <th>Data de Envio</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in documentos_para_revisar %}
                            <tr>
                                <td>{{ doc.funcionario.nome }}</td>
                                <td>
                                    <a href="{{ url_for('documentos.download_documento', filename=doc.path_armazenamento) }}" target="_blank" title="Baixar para visualizar">
                                        <i class="bi bi-file-earmark-text me-2"></i>{{ doc.tipo_documento }}
                                    </a>
                                </td>
                                <td>{{ doc.data_upload | localtime }}</td>
                                <td class="text-end">
                                    <form action="{{ url_for('documentos.aprovar_documento', documento_id=doc.id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success" title="Aprovar">
                                            <i class="bi bi-check-lg"></i> Aprovar
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modal-reprovar-{{ doc.id }}" title="Reprovar">
                                        <i class="bi bi-x-lg"></i> Reprovar
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center p-4">Nenhum documento pendente de revisão.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="solicitar" role="tabpanel" aria-labelledby="solicitar-tab">
        <div class="card shadow-sm card-tab">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-send-plus-fill"></i> Solicitar Documento</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('documentos.gestao_documentos') }}">
                    <div class="mb-3">
                        <label for="busca-solicitar" class="form-label">Funcionário</label>
                        <input type="text" class="form-control" id="busca-solicitar" placeholder="Comece a digitar o nome..." autocomplete="off">
                        <div id="resultados-solicitar" class="list-group mt-1"></div>
                        <input type="hidden" name="funcionario_id" id="funcionario_id_solicitar">
                    </div>
                    <div class="mb-3">
                        <label for="tipo_documento_solicitado" class="form-label">Tipo de Documento a Solicitar</label>
                        <input type="text" class="form-control" name="tipo_documento_solicitado" placeholder="Ex: Comprovante de Residência" required>
                    </div>
                    <button type="submit" class="btn btn-brand w-100">Enviar Solicitação</button>
                </form>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="enviar" role="tabpanel" aria-labelledby="enviar-tab">
        <div class="card shadow-sm card-tab">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-upload"></i> Enviar Documento Manualmente</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('documentos.upload_manual_documento') }}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="busca-enviar" class="form-label">Funcionário</label>
                        <input type="text" class="form-control" id="busca-enviar" placeholder="Comece a digitar o nome..." autocomplete="off">
                        <div id="resultados-enviar" class="list-group mt-1"></div>
                        <input type="hidden" name="funcionario_id" id="funcionario_id_enviar">
                    </div>
                    <div class="mb-3">
                        <label for="tipo_documento" class="form-label">Tipo de Documento</label>
                        <input type="text" class="form-control" name="tipo_documento" placeholder="Ex: Contrato, RG, Holerite" required>
                    </div>
                    <div class="mb-3">
                        <label for="arquivo" class="form-label">Selecione o arquivo</label>
                        <input class="form-control" type="file" id="arquivo" name="arquivo" required>
                    </div>
                    <button type="submit" class="btn btn-brand w-100">Enviar Documento</button>
                </form>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="consulta" role="tabpanel" aria-labelledby="consulta-tab">
        <div class="card shadow-sm card-tab">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-search"></i> Consultar Documentos do Colaborador</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="busca-consulta" class="form-label">Funcionário</label>
                    <input type="text" class="form-control" id="busca-consulta" placeholder="Comece a digitar o nome..." autocomplete="off">
                    <div id="resultados-consulta" class="list-group mt-1"></div>
                </div>
                <hr>
                <div id="historico-container" class="mt-3">
                    <p class="text-muted text-center">Selecione um funcionário para ver seus documentos.</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% for doc in documentos_para_revisar %}
<div class="modal fade" id="modal-reprovar-{{ doc.id }}" tabindex="-1" aria-labelledby="reprovarLabel-{{ doc.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reprovarLabel-{{ doc.id }}">Reprovar Documento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('documentos.reprovar_documento', documento_id=doc.id) }}" method="POST">
          <div class="modal-body">
            <p>Você está reprovando o documento <strong>{{ doc.tipo_documento }}</strong> de <strong>{{ doc.funcionario.nome }}</strong>. Por favor, informe o motivo abaixo para que o colaborador possa corrigir.</p>
            <div class="mb-3">
                <label for="motivo-{{ doc.id }}" class="form-label">Motivo da Reprovação</label>
                <textarea class="form-control" id="motivo-{{ doc.id }}" name="motivo_reprovacao" rows="3" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger">Confirmar Reprovação</button>
          </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    function setupBusca(inputId, resultadosId, hiddenInputId) {
        const buscaInput = document.getElementById(inputId);
        const resultadosDiv = document.getElementById(resultadosId);
        const hiddenInput = document.getElementById(hiddenInputId);
        let searchTimeout;

        buscaInput.addEventListener('keyup', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const termo = buscaInput.value.trim();
                resultadosDiv.innerHTML = '';
                if(hiddenInput) hiddenInput.value = '';

                if (termo.length < 2) return;

                const res = await fetch(`/api/buscar_funcionarios?q=${encodeURIComponent(termo)}`);
                const colaboradores = await res.json();
                
                if (colaboradores.length > 0) {
                    colaboradores.forEach(colab => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `<strong>${colab.nome}</strong><br><small class="text-muted">CPF: ${colab.cpf}</small>`;
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            buscaInput.value = colab.nome;
                            if(hiddenInput) {
                                hiddenInput.value = colab.id;
                            } else {
                                carregarHistorico(colab.id);
                            }
                            resultadosDiv.innerHTML = '';
                        });
                        resultadosDiv.appendChild(item);
                    });
                } else {
                    resultadosDiv.innerHTML = '<p class="list-group-item text-muted">Nenhum colaborador encontrado.</p>';
                }
            }, 300);
        });
    }

    setupBusca('busca-solicitar', 'resultados-solicitar', 'funcionario_id_solicitar');
    setupBusca('busca-enviar', 'resultados-enviar', 'funcionario_id_enviar');
    setupBusca('busca-consulta', 'resultados-consulta', null);

    const historicoContainer = document.getElementById('historico-container');
    async function carregarHistorico(funcionarioId) {
        historicoContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
        const res = await fetch(`/documentos/api/funcionario/${funcionarioId}/documentos`);
        const documentos = await res.json();

        if (documentos.length === 0) {
            historicoContainer.innerHTML = '<p class="text-muted text-center">Nenhum documento encontrado para este funcionário.</p>';
            return;
        }

        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Arquivo</th>
                            <th>Data Envio</th>
                            <th>Status</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        documentos.forEach(doc => {
            let statusBadge = '';
            if (doc.status === 'Pendente de Revisão') statusBadge = '<span class="badge bg-warning text-dark">Pendente</span>';
            else if (doc.status === 'Aprovado') statusBadge = '<span class="badge bg-success">Aprovado</span>';
            
            const btnDownload = `<a href="${doc.url_download}" class="btn btn-sm btn-outline-secondary" title="Baixar"><i class="bi bi-download"></i></a>`;
            const btnRemover = `<button class="btn btn-sm btn-outline-danger btn-remover-doc" data-doc-id="${doc.id}" title="Remover"><i class="bi bi-trash"></i></button>`;
            
            tableHtml += `
                <tr id="doc-row-${doc.id}">
                    <td>${doc.tipo_documento}</td>
                    <td>${doc.nome_arquivo}</td>
                    <td>${doc.data_upload}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">${btnDownload} ${btnRemover}</td>
                </tr>
            `;
        });

        tableHtml += '</tbody></table></div>';
        historicoContainer.innerHTML = tableHtml;
    }

    historicoContainer.addEventListener('click', function(event) {
        const target = event.target.closest('.btn-remover-doc');
        if (!target) return;
        
        const docId = target.dataset.docId;
        if (confirm('Tem certeza que deseja remover este documento permanentemente? Esta ação é irreversível.')) {
            fetch(`/documentos/api/documento/${docId}/remover`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`doc-row-${docId}`).remove();
                } else {
                    alert(data.message || 'Ocorreu um erro.');
                }
            });
        }
    });
});
</script>
{% endblock %}