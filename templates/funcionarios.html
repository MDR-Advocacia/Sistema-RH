{% extends "base.html" %}

{% block title %}Funcionários{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Funcionários</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('main.exibir_formulario_cadastro') }}" class="btn btn-sm btn-brand">
                <i class="bi bi-plus-circle"></i> Novo Funcionário
            </a>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-light p-3">
            <form method="GET" action="{{ url_for('main.listar_funcionarios') }}" class="d-flex justify-content-between align-items-center">
                <div class="flex-grow-1 me-3">
                    <div class="input-group">
                        <input type="text" class="form-control" name="q" placeholder="Buscar por nome, CPF ou setor..." value="{{ request.args.get('q', '') }}">
                        
                        <select name="status" class="form-select" style="max-width: 150px;">
                            <option value="ativos" {% if status_filter == 'ativos' %}selected{% endif %}>Ativos</option>
                            <option value="suspensos" {% if status_filter == 'suspensos' %}selected{% endif %}>Suspensos</option>
                            <option value="desligados" {% if status_filter == 'desligados' %}selected{% endif %}>Desligados</option>
                            <option value="todos" {% if status_filter == 'todos' %}selected{% endif %}>Todos</option>
                        </select>
                        
                        <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i> Buscar</button>
                    </div>
                </div>
                <div id="bulk-actions" class="btn-group d-none">
                    <button type="button" id="btn-alterar-lote" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal-editar-lote"><i class="bi bi-pencil-square"></i> Alterar</button>
                    <button type="button" id="btn-remover-lote" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Remover</button>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modal-importar-csv">
                        <i class="bi bi-upload"></i> Importar
                    </button>
                    <a href="{{ url_for('main.exportar_csv', q=request.args.get('q', '')) }}" class="btn btn-outline-success">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Exportar
                    </a>
                </div>
            </form>
        </div>
        
        <div class="card-body"> <div style="max-height: 65vh; overflow-y: auto; border: 1px solid #dee2e6; border-radius: .25rem;">
                <div class="table-responsive">
                    <table id="tabela-funcionarios" class="table table-hover align-middle mb-0">
                        <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th scope="col" class="text-center" style="width: 5%;"><input class="form-check-input" type="checkbox" id="selecionar-todos"></th>
                                <th scope="col">
                                    <a href="{{ url_for('main.listar_funcionarios', q=request.args.get('q', ''), sort='nome_asc' if request.args.get('sort') != 'nome_asc' else 'nome_desc') }}" class="text-decoration-none text-dark">
                                        Nome
                                        {% if request.args.get('sort') == 'nome_asc' %}<i class="bi bi-sort-alpha-down"></i>{% endif %}
                                        {% if request.args.get('sort') == 'nome_desc' %}<i class="bi bi-sort-alpha-up"></i>{% endif %}
                                    </a>
                                </th>
                                <th>Cargo</th>
                                <th>Setor</th>
                                <th>Email</th>
                                <th>Telefone</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for f in funcionarios %}
                            <tr data-id="{{ f.id }}">
                                <td class="text-center"><input class="form-check-input check-item" type="checkbox" value="{{ f.id }}"></td>
                                <td class="funcionario-link" style="cursor: pointer;">{{ f.nome or f.apelido}}</td>
                                <td>{{ f.cargo.nome or 'N/A' }}</td>
                                <td>{{ f.setor.nome or 'N/A' }}</td>
                                <td>{{ f.email }}</td>
                                <td>{{ f.telefone or 'N/A' }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center p-4">Nenhum funcionário encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
{% endblock %}

{% block content_after %}
<div class="modal fade" id="modal-detalhes" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="modal-nome">...</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body"><div id="modal-conteudo"><p>Carregando...</p></div></div>
      <div class="modal-footer">
        <button type="button" id="modal-btn-remover" class="btn btn-danger me-auto"><i class="bi bi-trash"></i> Remover</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        <a href="#" id="modal-link-alterar" class="btn btn-brand">Ver Perfil Completo</a>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="modal-importar-csv" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Importar em Lote</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <p>Siga os passos para importar múltiplos funcionários de uma vez:</p>
        <ol><li>Baixe o modelo CSV.</li><li>Preencha a planilha com os dados.</li><li>Anexe o arquivo preenchido.</li></ol><hr>
        <div class="d-grid gap-2">
            <a href="{{ url_for('static', filename='modelo_importacao.csv') }}" download class="btn btn-success"><i class="bi bi-download"></i> Baixar Modelo</a>
            <button type="button" id="btn-anexar-csv" class="btn btn-brand"><i class="bi bi-paperclip"></i> Anexar CSV</button>
            <input type="file" id="input-csv" style="display: none;" accept=".csv">
        </div>
        <div id="import-feedback" class="mt-3"></div>
      </div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button></div>
    </div>
  </div>
</div>
<div class="modal fade" id="modal-editar-lote" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">Alterar em Lote</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <form id="form-editar-lote">
          <div class="modal-body">
            <p>Alterar <strong id="contador-selecionados"></strong> funcionário(s). Preencha apenas os campos que deseja modificar.</p>
            <input type="hidden" name="ids" id="ids-para-alterar">
            <div class="mb-3">
                <label for="lote-cargo" class="form-label">Novo Cargo</label>
                <select class="form-select" id="lote-cargo" name="cargo">
                    <option value="">-- Manter Inalterado --</option>
                    {% for cargo in todos_cargos %}
                        <option value="{{ cargo.id }}">{{ cargo.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <label for="lote-setor" class="form-label">Novo Setor</label>
                <select class="form-select" id="lote-setor" name="setor">
                    <option value="">-- Manter Inalterado --</option>
                    {% for setor in todos_setores %}
                        <option value="{{ setor.id }}">{{ setor.nome }}</option>
                    {% endfor %}
                </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-brand">Salvar Alterações</button>
          </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }} 
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tabelaFuncionarios = document.getElementById('tabela-funcionarios');
    const modalElement = document.getElementById('modal-detalhes');
    if (!modalElement) return;

    const modal = new bootstrap.Modal(modalElement);
    const modalNome = document.getElementById('modal-nome');
    const modalConteudo = document.getElementById('modal-conteudo');
    const modalLinkAlterar = document.getElementById('modal-link-alterar');
    const modalBtnRemover = document.getElementById('modal-btn-remover');

    if (tabelaFuncionarios) {
        tabelaFuncionarios.addEventListener('click', function (event) {
            if (event.target.classList.contains('check-item') || event.target.tagName === 'INPUT') return;
            const linha = event.target.closest('tr[data-id]');
            if (!linha) return;
            const funcionarioId = linha.dataset.id;
            
            modalNome.textContent = 'Carregando...';
            modalConteudo.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
            modal.show();

            fetch(`/api/funcionario/${funcionarioId}`).then(res => res.json()).then(data => {
                modalNome.textContent = data.nome;
                modalLinkAlterar.href = `/funcionario/${data.id}/perfil`;
                modalBtnRemover.dataset.id = data.id;
                
                let docsHtml = data.documentos.length > 0 ? data.documentos.map(doc => `<li class="list-group-item d-flex justify-content-between align-items-center"><div><i class="bi bi-file-earmark-text me-2"></i><strong>${doc.tipo_documento}:</strong> ${doc.nome_arquivo}</div><a href="${doc.url_download}" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Baixar</a></li>`).join('') : '<li class="list-group-item">Nenhum documento encontrado.</li>';
                let pendsHtml = data.pendencias.length > 0 ? data.pendencias.map(p => `<li class="list-group-item">${p.descricao} <span class="badge bg-warning text-dark float-end">${p.status}</span></li>`).join('') : '<li class="list-group-item">Nenhuma pendência.</li>';

                modalConteudo.innerHTML = `<h5><i class="bi bi-person-badge"></i> Info. Profissionais</h5><div class="row mb-3"><div class="col-md-6"><strong>Cargo:</strong> ${data.cargo || 'N/A'}</div><div class="col-md-6"><strong>Setor:</strong> ${data.setor || 'N/A'}</div></div><h5><i class="bi bi-person-lines-fill"></i> Dados Pessoais</h5><div class="row mb-3"><div class="col-md-6"><strong>CPF:</strong> ${data.cpf}</div><div class="col-md-6"><strong>Nasc.:</strong> ${data.data_nascimento}</div><div class="col-md-6"><strong>E-mail:</strong> ${data.email}</div><div class="col-md-6"><strong>Telefone:</strong> ${data.telefone || 'N/A'}</div></div><h5><i class="bi bi-telephone-fill"></i> Contato de Emergência</h5><div class="row mb-4"><div class="col-md-6"><strong>Nome:</strong> ${data.contato_emergencia_nome}</div><div class="col-md-6"><strong>Telefone:</strong> ${data.contato_emergencia_telefone}</div></div><hr><h4><i class="bi bi-file-earmark-zip-fill"></i> Documentos</h4><ul class="list-group list-group-flush mb-4">${docsHtml}</ul><h4><i class="bi bi-exclamation-triangle-fill"></i> Pendências</h4><ul class="list-group list-group-flush">${pendsHtml}</ul>`;
            });
        });
    }

    if(modalBtnRemover) {
        modalBtnRemover.addEventListener('click', function() {
            const funcionarioId = this.dataset.id;
            const nomeFuncionario = document.getElementById('modal-nome').textContent;
            if (confirm(`Remover "${nomeFuncionario}"? Ação irreversível!`)) {
                fetch(`/api/funcionario/${funcionarioId}/remover`, { method: 'DELETE' }).then(res => res.json()).then(data => {
                    alert(data.message); // Usando alert simples para feedback
                    if (data.success) {
                        modal.hide();
                        document.querySelector(`tr[data-id='${funcionarioId}']`).remove();
                    }
                });
            }
        });
    }

    const selecionarTodos = document.getElementById('selecionar-todos');
    const checkItens = document.querySelectorAll('.check-item');
    const bulkActions = document.getElementById('bulk-actions');
    const btnRemoverLote = document.getElementById('btn-remover-lote');
    const btnAlterarLote = document.getElementById('btn-alterar-lote');

    function toggleBulkActions() {
        const anyChecked = document.querySelectorAll('.check-item:checked').length > 0;
        bulkActions.classList.toggle('d-none', !anyChecked);
    }

    if(selecionarTodos) {
        selecionarTodos.addEventListener('change', () => { checkItens.forEach(c => c.checked = selecionarTodos.checked); toggleBulkActions(); });
        checkItens.forEach(c => c.addEventListener('change', () => {
            selecionarTodos.checked = document.querySelectorAll('.check-item:checked').length === checkItens.length;
            toggleBulkActions();
        }));
    }

    if (btnRemoverLote) {
        btnRemoverLote.addEventListener('click', function() {
            const ids = Array.from(document.querySelectorAll('.check-item:checked')).map(cb => cb.value);
            if (ids.length === 0) return;
            if (confirm(`Remover ${ids.length} funcionário(s)?`)) {
                fetch('/api/funcionarios/remover-em-lote', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: ids })
                }).then(res => res.json()).then(data => {
                    alert(data.message);
                    if (data.success) window.location.reload();
                });
            }
        });
    }
    
    // --- LÓGICA CORRIGIDA PARA O BOTÃO DE ALTERAR EM LOTE ---
    if (btnAlterarLote) {
        btnAlterarLote.addEventListener('click', function() {
            const ids = Array.from(document.querySelectorAll('.check-item:checked')).map(cb => cb.value);
            if (ids.length > 0) {
                document.getElementById('ids-para-alterar').value = ids.join(',');
                document.getElementById('contador-selecionados').textContent = ids.length;
            }
        });
    }
    
    const formEditarLote = document.getElementById('form-editar-lote');
    if (formEditarLote) {
        formEditarLote.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const ids = document.getElementById('ids-para-alterar').value.split(',');
            const cargo = document.getElementById('lote-cargo').value;
            const setor = document.getElementById('lote-setor').value;
            
            if (ids.length === 0 || ids[0] === '') {
                alert("Nenhum funcionário selecionado.");
                return;
            }

            // Garante que não envie uma requisição vazia se nada for selecionado
            if (!cargo && !setor) {
                alert("Preencha pelo menos um campo (Novo Cargo ou Novo Setor) para alterar.");
                return;
            }

            // A URL da sua API estava como 'editar-em-lote', ajustei para o nome da função em routes.py
            fetch('/api/funcionarios/editar-em-lote', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ids: ids, cargo: cargo, setor: setor })
            })
            .then(res => res.json())
            .then(data => {
                // Exibe a mensagem recebida da API, evitando o "undefined"
                alert(data.message || 'Ocorreu um erro desconhecido.');
                if (data.success) {
                    window.location.reload(); // Recarrega a página em caso de sucesso
                }
            })
            .catch(error => {
                console.error('Erro na requisição:', error);
                alert('Falha de comunicação com o servidor.');
            });
        });
    }

    const btnAnexar = document.getElementById('btn-anexar-csv');
    const inputCsv = document.getElementById('input-csv');
    const importFeedback = document.getElementById('import-feedback');
    if (btnAnexar) {
        btnAnexar.addEventListener('click', () => inputCsv.click());
        inputCsv.addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return;
            const formData = new FormData(); formData.append('arquivo', file);
            importFeedback.innerHTML = `<p class="text-muted">Enviando: ${file.name}</p>`;
            fetch("{{ url_for('main.importar_csv') }}", { method: 'POST', body: formData }).then(res => res.json()).then(data => {
                const alertClass = data.success ? 'alert-success' : 'alert-danger';
                importFeedback.innerHTML = `<div class="alert ${alertClass}">${data.message}</div>`;
                if (data.success) setTimeout(() => window.location.reload(), 2000);
            }).catch(e => importFeedback.innerHTML = '<div class="alert alert-danger">Erro de comunicação.</div>').finally(() => {
                inputCsv.value = '';
            });
        });
    }
});
</script>
{% endblock %}