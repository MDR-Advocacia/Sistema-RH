{% extends "base.html" %}

{% block title %}Perfil de {{ funcionario.nome }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-0">Perfil do Colaborador</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent p-0 mb-0">
                <li class="breadcrumb-item"><a href="{{ url_for('main.listar_funcionarios') }}">Funcionários</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ funcionario.apelido or funcionario.nome }}</li>
            </ol>
        </nav>
    </div>
    <div class="btn-toolbar">
        <form method="POST" action="{{ url_for('main.desligar_funcionario', funcionario_id=funcionario.id) }}" class="me-2" 
              onsubmit="return confirm('ATENÇÃO: Esta ação irá DESLIGAR o colaborador. A conta no AD será desativada e dados pessoais serão anonimizados. Deseja continuar?');">
            <button type="submit" class="btn btn-danger" {% if funcionario.status == 'Desligado' %}disabled{% endif %}>
                <i class="bi bi-person-x-fill"></i> Desligar Colaborador
            </button>
        </form>

        <form method="POST" action="{{ url_for('main.toggle_status', funcionario_id=funcionario.id) }}" class="me-2">
            {% if funcionario.status == 'Ativo' %}
                <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Tem certeza que deseja suspender este usuário? Ele não poderá mais acessar o sistema.');">
                    <i class="bi bi-person-fill-slash"></i> Suspender
                </button>
            {% elif funcionario.status == 'Suspenso' %}
                <button type="submit" class="btn btn-outline-success" onclick="return confirm('Tem certeza que deseja reativar este usuário?');">
                    <i class="bi bi-person-fill-check"></i> Reativar
                </button>
            {% endif %}
        </form>

        <a href="{{ url_for('main.editar_funcionario', funcionario_id=funcionario.id) }}" class="btn btn-brand">
            <i class="bi bi-pencil-square"></i> Editar Cadastro
        </a>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header p-4 d-flex align-items-center">
        {% if funcionario.foto_perfil %}
            <img src="{{ url_for('perfil.uploaded_file', filename=funcionario.foto_perfil) }}" alt="Foto de Perfil" width="80" height="80" class="rounded-circle me-4" style="object-fit: cover;">
        {% else %}
            <i class="bi bi-person-circle fs-1 me-4 text-secondary" style="font-size: 80px !important;"></i>
        {% endif %}
        <div>
            <h3 class="mb-0">{{ funcionario.nome }}</h3>
            <p class="mb-0 text-muted">{{ funcionario.cargo or 'Cargo não informado' }} | {{ funcionario.setor or 'Setor não informado' }}</p>
            {% if funcionario.status != 'Ativo' %}
                <span class="badge bg-danger mt-2">{{ funcionario.status }}</span>
                {% if funcionario.data_desligamento %}
                    <span class="text-muted small">em {{ funcionario.data_desligamento.strftime('%d/%m/%Y') }}</span>
                {% endif %}
            {% endif %}
        </div>
    </div>
    <div class="card-body p-4">
        <ul class="nav nav-tabs" id="perfilTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dados-tab" data-bs-toggle="tab" data-bs-target="#dados" type="button" role="tab">Dados Cadastrais</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="documentos-tab" data-bs-toggle="tab" data-bs-target="#documentos" type="button" role="tab">Documentos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ponto-tab" data-bs-toggle="tab" data-bs-target="#ponto" type="button" role="tab">Controle de Ponto</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pendencias-tab" data-bs-toggle="tab" data-bs-target="#pendencias" type="button" role="tab">Pendências <span class="badge rounded-pill bg-danger">{{ pendencias|length }}</span></button>
            </li>
        </ul>

        <div class="tab-content pt-3" id="perfilTabContent">
            <div class="tab-pane fade show active" id="dados" role="tabpanel">
                <h5>Dados Pessoais</h5>
                <p><strong>CPF:</strong> {{ funcionario.cpf }}</p>
                <p><strong>E-mail:</strong> {{ funcionario.email }}</p>
                <p><strong>Telefone:</strong> {{ funcionario.telefone or 'N/A' }}</p>
                <p><strong>Data de Nascimento:</strong> {% if funcionario.data_nascimento %}{{ funcionario.data_nascimento.strftime('%d/%m/%Y') }}{% else %}N/A{% endif %}</p>
                <hr>
                <h5>Contato de Emergência</h5>
                <p><strong>Nome:</strong> {{ funcionario.contato_emergencia_nome or 'N/A' }}</p>
                <p><strong>Telefone:</strong> {{ funcionario.contato_emergencia_telefone or 'N/A' }}</p>
            </div>
            
            <div class="tab-pane fade" id="documentos" role="tabpanel">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Tipo do Documento</th>
                                <th>Nome do Arquivo</th>
                                <th>Data de Upload</th>
                                <th class="text-end">Ação</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in funcionario.documentos|sort(attribute='data_upload', reverse=True) %}
                            <tr>
                                <td>{{ doc.tipo_documento }}</td>
                                <td><i class="bi bi-file-earmark-text me-2"></i>{{ doc.nome_arquivo }}</td>
                                <td>{{ doc.data_upload | localtime }}</td>
                                <td class="text-end">
                                    <a href="{{ url_for('documentos.download_documento', filename=doc.path_armazenamento) }}" class="btn btn-sm btn-outline-primary"><i class="bi bi-download"></i> Baixar</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center p-4">Nenhum documento encontrado.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="tab-pane fade" id="ponto" role="tabpanel">
                <div class="row">
                    <div class="col-md-5">
                        <h5 class="mb-3"><i class="bi bi-send-plus-fill"></i> Solicitar Ajuste de Ponto</h5>
                        <div class="card">
                            <div class="card-body">
                                 <form method="POST" action="{{ url_for('ponto.solicitar_ponto', funcionario_id=funcionario.id) }}">
                                    <div class="mb-3">
                                        <label for="data_ajuste" class="form-label">Data do Ajuste</label>
                                        <input type="date" class="form-control" id="data_ajuste" name="data_ajuste" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="tipo_ajuste" class="form-label">Tipo de Ajuste</label>
                                        <select class="form-select" id="tipo_ajuste" name="tipo_ajuste" required>
                                            <option value="" selected disabled>Selecione o tipo...</option>
                                            <option value="Entrada no escritório">Entrada no escritório</option>
                                            <option value="Saída para o intervalo">Saída para o intervalo</option>
                                            <option value="Volta do intervalo">Volta do intervalo</option>
                                            <option value="Saída do escritório">Saída do escritório</option>
                                        </select>
                                    </div>
                                    <button type="submit" class="btn btn-brand w-100">Criar Pendência</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <h5 class="mb-3"><i class="bi bi-list-check"></i> Histórico de Ajustes</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Status</th>
                                        <th class="text-end">Ação</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for p in pontos %}
                                    <tr>
                                        <td>{{ p.data_ajuste.strftime('%d/%m/%Y') }}</td>
                                        <td>{{ p.tipo_ajuste }}</td>
                                        <td>
                                            {% if p.status == 'Pendente' %}
                                                <span class="badge bg-warning text-dark">{{ p.status }}</span>
                                            {% elif p.status == 'Em Revisão' %}
                                                <span class="badge bg-info">{{ p.status }}</span>
                                            {% else %}
                                                <span class="badge bg-success">{{ p.status }}</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if p.path_assinado %}
                                                <a href="{{ url_for('ponto.download_ponto_assinado', filename=p.path_assinado) }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-download"></i> Baixar</a>
                                            {% endif %}
                                            <form method="POST" action="{{ url_for('ponto.remover_ponto', ponto_id=p.id) }}" class="d-inline" onsubmit="return confirm('Tem certeza que deseja remover esta solicitação de ajuste? Esta ação é irreversível.');">
                                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Remover Solicitação">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="4" class="text-center p-3">Nenhum registro de ponto.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="pendencias" role="tabpanel">
                <ul class="list-group list-group-flush">
                {% for p in pendencias %}
                    <li class="list-group-item">
                        {{ p.descricao }} 
                        <span class="badge bg-warning text-dark float-end">{{ p.status }}</span>
                    </li>
                {% else %}
                    <li class="list-group-item text-center text-muted">Nenhuma pendência para este colaborador.</li>
                {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}