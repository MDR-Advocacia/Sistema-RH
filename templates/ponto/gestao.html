{% extends "base.html" %}

{% block title %}Gestão de Ponto{% endblock %}

{% block content %}
<h1 class="h2 mb-4">Gestão de Ponto</h1>

<ul class="nav nav-tabs" id="pontoTab" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="revisao-tab" data-bs-toggle="tab" data-bs-target="#revisao" type="button" role="tab" aria-controls="revisao" aria-selected="true">
            Revisão de Pontos
            {% if pontos_para_revisar %}
                <span class="badge rounded-pill bg-danger">{{ pontos_para_revisar|length }}</span>
            {% endif %}
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="solicitar-tab" data-bs-toggle="tab" data-bs-target="#solicitar" type="button" role="tab" aria-controls="solicitar" aria-selected="false">
            Solicitar Novo Ajuste
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="solicitar-lote-tab" data-bs-toggle="tab" data-bs-target="#solicitar-lote" type="button" role="tab">
            <i class="bi bi-send-plus-fill"></i> Solicitar Ajuste em Lote
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="consultar-tab" data-bs-toggle="tab" data-bs-target="#consultar" type="button" role="tab" aria-controls="consultar" aria-selected="false">
            Consultar Histórico
        </button>
    </li>
</ul>

<div class="tab-content" id="pontoTabContent">
    
    <div class="tab-pane fade show active" id="revisao" role="tabpanel" aria-labelledby="revisao-tab">
        <div class="card shadow-sm card-tab">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> Pontos Pendentes de Revisão</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Funcionário</th>
                                <th>Data do Ajuste</th>
                                <th>Data de Envio</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ponto in pontos_para_revisar %}
                            <tr>
                                <td>{{ ponto.funcionario.nome }}</td>
                                <td>{{ ponto.data_ajuste.strftime('%d/%m/%Y') }}</td>
                                <td>{{ ponto.data_upload | localtime }}</td>
                                <td class="text-end">
                                    <a href="{{ url_for('ponto.download_ponto_assinado', filename=ponto.path_assinado) }}" target="_blank" class="btn btn-sm btn-outline-secondary" title="Baixar Ponto Assinado">
                                        <i class="bi bi-download"></i> Visualizar
                                    </a>
                                    <form action="{{ url_for('ponto.aprovar_ponto', ponto_id=ponto.id) }}" method="POST" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success" title="Aprovar">
                                            <i class="bi bi-check-lg"></i> Aprovar
                                        </button>
                                    </form>
                                    <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#modal-reprovar-ponto-{{ ponto.id }}" title="Reprovar">
                                        <i class="bi bi-x-lg"></i> Reprovar
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center p-4">Nenhum ponto pendente de revisão.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="solicitar" role="tabpanel" aria-labelledby="solicitar-tab">
        <div class="card shadow-sm card-tab">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-send-plus"></i> Solicitar Ajuste de Ponto</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('ponto.gestao_ponto') }}">
                    <div class="mb-3">
                        <label for="busca-funcionario" class="form-label">Funcionário</label>
                        <input type="text" class="form-control" id="busca-funcionario" placeholder="Comece a digitar o nome do colaborador..." autocomplete="off">
                        <div id="resultados-busca" class="list-group mt-1"></div>
                        <input type="hidden" name="funcionario_id" id="funcionario_id">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="data_ajuste" class="form-label">Data do Ajuste</label>
                            <input type="date" class="form-control" id="data_ajuste" name="data_ajuste" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tipo_ajuste" class="form-label">Tipo de Ajuste</label>
                            <select class="form-select" id="tipo_ajuste" name="tipo_ajuste" required>
                                <option value="" selected disabled>Selecione...</option>
                                <option value="Entrada no escritório">Entrada no escritório</option>
                                <option value="Saída para o intervalo">Saída para o intervalo</option>
                                <option value="Volta do intervalo">Volta do intervalo</option>
                                <option value="Saída do escritório">Saída do escritório</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-brand w-100">Criar Pendência</button>
                </form>
            </div>
        </div>
    </div>

    <div class="tab-pane fade" id="solicitar-lote" role="tabpanel" aria-labelledby="solicitar-lote-tab">
        <div class="card shadow-sm card-tab">
            <div class="card-header">
                <h5 class="mb-0">Solicitar Ajuste de Ponto em Lote</h5>
            </div>
            <div class="card-body">
                <p class="card-text">Selecione os funcionários e informe os detalhes do ajuste a ser solicitado.</p>
                
                <form action="{{ url_for('ponto.solicitar_ajuste_em_lote') }}" method="POST">
                    <div class="row">
                        <div class="col-md-4">
                            <h6>1. Detalhes do Ajuste</h6>
                            <div class="mb-3">
                                <label for="data_ajuste" class="form-label">Data do Ajuste</label>
                                <input type="date" class="form-control" name="data_ajuste" id="data_ajuste" required>
                            </div>
                            <div class="mb-3">
                                <label for="tipo_ajuste" class="form-label">Tipo do Ajuste</label>
                                <select name="tipo_ajuste" id="tipo_ajuste" class="form-select" required>
                                    <option value="" selected disabled>-- Selecione o Motivo --</option>
                                    <option value="Atestado Médico">Atestado Médico</option>
                                    <option value="Esquecimento de marcação">Esquecimento de marcação</option>
                                    <option value="Visita Externa">Visita Externa</option>
                                    <option value="Problema no Registrador">Problema no Registrador</option>
                                    <option value="Outros">Outros</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-brand w-100">
                                <i class="fas fa-paper-plane"></i> Enviar Solicitação
                            </button>
                        </div>

                        <div class="col-md-8">
                            <h6>2. Selecione os Funcionários</h6>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th style="width: 10%;"><input type="checkbox" class="form-check-input" id="selecionar-todos-ponto"></th>
                                            <th>Nome</th>
                                            <th>Setor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for func in funcionarios %}
                                        <tr>
                                            <td><input type="checkbox" class="form-check-input" name="funcionarios_selecionados" value="{{ func.id }}"></td>
                                            <td>{{ func.nome }}</td>
                                            <td>{{ func.setor }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="tab-pane fade" id="consultar" role="tabpanel" aria-labelledby="consultar-tab">
        <div class="card shadow-sm card-tab">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-search"></i> Consultar Histórico de Colaborador</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="busca-consulta" class="form-label">Funcionário</label>
                    <input type="text" class="form-control" id="busca-consulta" placeholder="Comece a digitar o nome..." autocomplete="off">
                    <div id="resultados-consulta" class="list-group mt-1"></div>
                </div>
                <hr>
                <div id="historico-container" class="mt-3">
                    <p class="text-muted text-center">Selecione um funcionário para ver seu histórico de ajustes.</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% for ponto in pontos_para_revisar %}
<div class="modal fade" id="modal-reprovar-ponto-{{ ponto.id }}" tabindex="-1" aria-labelledby="reprovarPontoLabel-{{ ponto.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reprovarPontoLabel-{{ ponto.id }}">Reprovar Ajuste de Ponto</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('ponto.reprovar_ponto', ponto_id=ponto.id) }}" method="POST">
          <div class="modal-body">
            <p>Você está reprovando o ajuste de <strong>{{ ponto.funcionario.nome }}</strong> para a data <strong>{{ ponto.data_ajuste.strftime('%d/%m/%Y') }}</strong>. Por favor, informe o motivo abaixo.</p>
            <div class="mb-3">
                <label for="motivo-{{ ponto.id }}" class="form-label">Motivo da Reprovação</label>
                <textarea class="form-control" id="motivo-{{ ponto.id }}" name="motivo_reprovacao" rows="3" required></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger">Confirmar Reprovação</button>
          </div>
      </form>
    </div>
  </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- LÓGICA DE BUSCA GENÉRICA ---
    function setupBusca(inputId, resultadosId, hiddenInputId) {
        const buscaInput = document.getElementById(inputId);
        const resultadosDiv = document.getElementById(resultadosId);
        const hiddenInput = document.getElementById(hiddenInputId);
        let searchTimeout;

        const selecionarTodosPonto = document.getElementById('selecionar-todos-ponto');
        if (selecionarTodosPonto) {
            selecionarTodosPonto.addEventListener('change', function(e) {
                const isChecked = e.target.checked;
                // Importante: seleciona apenas os checkboxes DENTRO do formulário de ponto
                const checkboxes = document.querySelectorAll('#solicitar-lote input[name="funcionarios_selecionados"]');
                checkboxes.forEach(checkbox => checkbox.checked = isChecked);
            });
        }

        buscaInput.addEventListener('keyup', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                const termo = buscaInput.value.trim();
                resultadosDiv.innerHTML = '';
                if(hiddenInput) hiddenInput.value = '';

                if (termo.length < 2) return;

                const res = await fetch(`/api/buscar_funcionarios?q=${encodeURIComponent(termo)}`);
                const colaboradores = await res.json();
                
                if (colaboradores.length > 0) {
                    colaboradores.forEach(colab => {
                        const item = document.createElement('a');
                        item.href = '#';
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `<strong>${colab.nome}</strong><br><small class="text-muted">CPF: ${colab.cpf}</small>`;
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            buscaInput.value = colab.nome;
                            if(hiddenInput) {
                                hiddenInput.value = colab.id;
                            } else {
                                carregarHistorico(colab.id);
                            }
                            resultadosDiv.innerHTML = '';
                        });
                        resultadosDiv.appendChild(item);
                    });
                } else {
                    resultadosDiv.innerHTML = '<p class="list-group-item text-muted">Nenhum colaborador encontrado.</p>';
                }
            }, 300);
        });
    }

    setupBusca('busca-funcionario', 'resultados-busca', 'funcionario_id');
    setupBusca('busca-consulta', 'resultados-consulta', null);

    const historicoContainer = document.getElementById('historico-container');

    async function carregarHistorico(funcionarioId) {
        historicoContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div></div>';
        const res = await fetch(`/ponto/api/funcionario/${funcionarioId}/historico`);
        const pontos = await res.json();

        if (pontos.length === 0) {
            historicoContainer.innerHTML = '<p class="text-muted text-center">Nenhum histórico de ajuste de ponto para este funcionário.</p>';
            return;
        }

        let tableHtml = `
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        pontos.forEach(ponto => {
            let statusBadge = '';
            if (ponto.status === 'Pendente') statusBadge = '<span class="badge bg-warning text-dark">Pendente</span>';
            else if (ponto.status === 'Em Revisão') statusBadge = '<span class="badge bg-info">Em Revisão</span>';
            else if (ponto.status === 'Aprovado') statusBadge = '<span class="badge bg-success">Aprovado</span>';
            
            const btnDownload = ponto.path_assinado 
                ? `<a href="${ponto.path_assinado}" class="btn btn-sm btn-outline-secondary" title="Baixar Anexo"><i class="bi bi-download"></i></a>` 
                : '';
            const btnRemover = `<button class="btn btn-sm btn-outline-danger btn-remover-ponto" data-ponto-id="${ponto.id}" title="Remover"><i class="bi bi-trash"></i></button>`;

            tableHtml += `
                <tr id="ponto-row-${ponto.id}">
                    <td>${ponto.data_ajuste}</td>
                    <td>${ponto.tipo_ajuste}</td>
                    <td>${statusBadge}</td>
                    <td class="text-end">${btnDownload} ${btnRemover}</td>
                </tr>
            `;
        });

        tableHtml += '</tbody></table></div>';
        historicoContainer.innerHTML = tableHtml;
    }

    historicoContainer.addEventListener('click', function(event) {
        const target = event.target.closest('.btn-remover-ponto');
        if (!target) return;
        
        const pontoId = target.dataset.pontoId;
        if (confirm('Tem certeza que deseja remover este registro de ponto? Esta ação é irreversível.')) {
            fetch(`/ponto/api/ponto/${pontoId}/remover`, {
                method: 'DELETE'
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`ponto-row-${pontoId}`).remove();
                } else {
                    alert(data.message || 'Ocorreu um erro.');
                }
            });
        }
    });
});
</script>
{% endblock %}